<!DOCTYPE html>
<html>
<head>
  <title>ONT ID Secure Login</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7f6; /* Light, clean background */
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      max-width: 900px;
      width: 90%;
      overflow: hidden;
    }

    .image-section {
      flex: 1;
      background: linear-gradient(135deg, #2A54E3, #0E2472); /* Ontology Gradient */
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      text-align: center;
    }

    .image-section h2 {
      font-size: 2.5em;
      margin-bottom: 20px;
    }

    .image-section p {
      font-size: 1.1em;
      line-height: 1.6;
    }

    .login-section {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: stretch; /* Make buttons fill the width */
    }

    .login-section h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }

    #walletAddress {
      margin: 20px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-weight: bold;
      color: #555;
      text-align: center;
      word-wrap: break-word;
    }

    button {
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    #loginBtn {
      background-color: #0E2472; /* Ontology Dark Blue */
      color: white;
    }
    
    #loginBtn:hover {
      background-color: #2A54E3; /* Ontology Light Blue */
    }

    #logoutBtn {
      background-color: #dc3545;
      color: white;
      display: none; /* Hidden by default */
    }
    
    #logoutBtn:hover {
      background-color: #c82333;
    }

    #loginBtn:disabled {
      background-color: #5cb85c; /* Success green */
      cursor: not-allowed;
      opacity: 1;
    }

    #result {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      min-height: 24px;
    }
    
    .success {
      color: #28a745; /* Green for success */
    }

    .error {
      color: #dc3545; /* Red for error */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="image-section">
      <h2>Secure Platform</h2>
      <p>Decentralized login powered by ONT ID.</p>
      <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22" x2="12" y2="12"></line></svg>
    </div>
    <div class="login-section">
      <h1>Login with ONT ID</h1>
      <div id="walletAddress" style="display: none;"></div>
      <button id="loginBtn">Login with ONT ID</button>
      <button id="logoutBtn">Logout</button>
      <div id="result"></div>
    </div>
  </div>

  <script>
    // UI elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const resultDiv = document.getElementById("result");
    const walletAddressDiv = document.getElementById("walletAddress");

    const provider = window.ethereum || window.onto;

    function updateUI(isLoggedIn) {
      if (isLoggedIn) {
        loginBtn.textContent = "Connected";
        loginBtn.disabled = true;
        logoutBtn.style.display = "block";
        const walletAddress = localStorage.getItem("walletAddress");
        if (walletAddress) {
          walletAddressDiv.textContent = `Wallet: ${walletAddress.substring(0, 6)}...${walletAddress.slice(-4)}`;
          walletAddressDiv.style.display = "block";
        }
        resultDiv.textContent = "✅ Logged in successfully!";
        resultDiv.className = "success";
      } else {
        loginBtn.textContent = "Login with ONT ID";
        loginBtn.disabled = false;
        loginBtn.style.backgroundColor = "";
        logoutBtn.style.display = "none";
        walletAddressDiv.textContent = "";
        walletAddressDiv.style.display = "none";
        resultDiv.textContent = "";
        resultDiv.className = "";
      }
    }

    const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
    updateUI(isLoggedIn);

    window.signData = function(account, signData) {
      return new Promise((resolve, reject) => {
        const methods = ['eth_signTypedData_v4', 'eth_signTypedData_v3', 'eth_signTypedData'];
        let methodIndex = 0;

        function tryNextMethod() {
          if (methodIndex >= methods.length) {
            console.log("Falling back to eth_sign...");
            const message = `Login to ONT ID Demo: ${signData.message.nonce}`;
            provider.request({
              method: 'eth_sign',
              params: [account, message]
            })
            .then(signature => {
              console.log("Signed successfully with eth_sign");
              resolve({ signature, method: 'eth_sign' });
            })
            .catch(error => {
              console.warn(`eth_sign failed: ${error.message}`);
              reject(new Error('Signature request was rejected or failed.'));
            });
            return;
          }
          
          const method = methods[methodIndex]; 
          console.log(`Attempting to sign with ${method}...`);

          provider.request({
            method,
            params: [account, JSON.stringify(signData)]
          })
          .then(signature => {
            console.log(`Signed successfully with ${method}`);
            resolve({ signature, method });
          })
          .catch(error => {
            console.warn(`Method ${method} failed: ${error.message}`);
            methodIndex++;
            tryNextMethod();
          });
        }
        tryNextMethod();
      });
    };

    loginBtn.addEventListener("click", async () => {
      resultDiv.textContent = "Connecting to wallet...";
      resultDiv.className = "";
      try {
        if (!provider) {
          throw new Error("No wallet provider found. Install ONTO Wallet or MetaMask.");
        }

        console.log("Requesting accounts...");
        const accounts = await provider.request({ method: "eth_requestAccounts" });
        const account = accounts[0];
        if (!account) {
            throw new Error("No accounts found in the wallet.");
        }
        console.log("Account:", account);
        
        // --- THIS PART IS RESTORED TO MATCH YOUR ORIGINAL FUNCTIONALITY ---
        const authRequest = {
          type: "AuthRequest",
          chain: "eth",
          app: "ONT ID Demo App",
          name: "ONT ID Demo",
          version: "1.0",
          challenge: "login-challenge",
          domain: window.location.hostname,
          issuer: "did:ont:issuer",
          requestId: Date.now().toString(),
          callbackUrl: `${window.location.protocol}//${window.location.host}/submit-auth`
        };

        console.log("Fetching challenge from backend using POST...");
        const challengeResponse = await fetch("/get-challenge", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ authRequest })
        });
        if (!challengeResponse.ok) throw new Error(`Server error fetching challenge: ${challengeResponse.statusText}`);
        const challenge = await challengeResponse.json();
        console.log("Challenge received:", challenge);
        // --- END OF RESTORED SECTION ---

        const did = `did:etho:${account.replace("0x", "")}`;
        console.log("DID:", did);

        const signData = {
          types: {
            EIP712Domain: [
              { name: "name", type: "string" }, { name: "version", type: "string" },
              { name: "chainId", type: "uint256" }, { name: "verifyingContract", type: "address" }
            ],
            AuthChallenge: [
              { name: "nonce", type: "string" }, { name: "did", type: "string" },
              { name: "created", type: "string" }
            ]
          },
          domain: {
            name: "ONT ID Demo", version: "1.0", chainId: 1,
            verifyingContract: "0x0000000000000000000000000000000000000000"
          },
          primaryType: "AuthChallenge",
          message: {
            nonce: challenge.nonce, did, created: new Date().toISOString()
          }
        };

        resultDiv.textContent = "Please sign the message in your wallet...";
        const { signature, method } = await window.signData(account, signData);
        console.log("Signature:", signature, "Method:", method);

        const authResponse = {
          ver: "1.0", type: "ClientResponse", nonce: challenge.nonce, did,
          proof: {
            type: method === 'eth_sign' ? 'eth_sign' : 'ecdsa',
            verificationMethod: `${did}#key-1`, created: signData.message.created, value: signature
          }, VPs: []
        };
        
        console.log("Submitting auth response to backend...");
        const resultResponse = await fetch("/submit-auth", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify(authResponse)
        });
        if (!resultResponse.ok) throw new Error(`Server error submitting signature: ${resultResponse.statusText}`);
        const result = await resultResponse.json();
        if (result.error) throw new Error(result.error);
        console.log("Login result:", result);

        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("walletAddress", account);
        updateUI(true);

      } catch (error) {
        console.error("Login process error:", error);
        resultDiv.textContent = `❌ ${error.message}`;
        resultDiv.className = "error";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("walletAddress");
      updateUI(false);
      resultDiv.textContent = "You have been logged out.";
      resultDiv.className = "";
    });
  </script>
</body>
</html>